---
typora-copy-images-to: ./
---

# 序章

## 0.1缓冲区

![](D:\git\读书笔记\NIO\未命名1592896024.png)

**用户进程如何与磁盘打交道：**

图 1-1 简单描述了数据从外部磁盘向运行中的进程的内存区域移动的过程。进程使用 read( )系
统调用，要求其缓冲区被填满。内核随即向磁盘控制硬件发出命令，要求其从磁盘读取数据。磁盘
控制器把数据直接写入内核内存缓冲区，这一步通过 DMA 完成，无需主 CPU 协助。一旦磁盘控
制器把缓冲区装满，内核即把数据从内核空间的临时缓冲区拷贝到进程执行 read( )调用时指定的缓
冲区。 

用户空间：常规进程所在区域，如JVM;该区域进程不能直接访问硬件设备。

内核空间：操作系统所在区域，能与硬件设备控制器进行通讯。



许多操作系统能把组装／分解过程进行得更加高效。根据发散／汇聚的概念，进程只需一个系
统调用，就能把一连串缓冲区地址传递给操作系统。然后，内核就可以顺序填充或排干多个缓冲
区，读的时候就把数据发散到多个用户空间缓冲区，写的时候再从多个缓冲区把数据汇聚起来（图
1-2）。 

![](D:\git\读书笔记\NIO\未命名1592896649.png)

## 0.2虚拟内存

虚拟内存意为使用虚假（或虚拟）地址取代物理（硬件RAM）内存地址。使用好处：
1. 一个以上的虚拟地址可指向同一个物理内存地址。 

2. 虚拟内存空间可大于实际可用的硬件内存。

   

上面说过设备控制器不能通过 DMA 直接存储到用户空间，但通过利用上面提到的第一项，则可以达到相同效果。把内核空间地址与用户空间的虚拟地址映射到同一个物理地址，这样，DMA 硬件（只能访问物理内存地址）就可以填充对内核与用户空间进程同时可见的缓冲区（见图1-3）。 

![未命名1592897171](D:\git\读书笔记\NIO\未命名1592897171.png)



## 0.3文件I/O

文件 I/O 属文件系统范畴，文件系统与磁盘迥然不同。磁盘把数据存在扇区上，通常一个扇区
512 字节。磁盘属硬件设备，对何谓文件一无所知，它只是提供了一系列数据存取窗口。在这点
上，磁盘扇区与内存页颇有相似之处：都是统一大小，都可作为大的数组被访问

我们的操作对象大部分也是文件对象





## 0.4流I/O



# 1.缓冲区

一个Buffer对象是固定数量的数据的容器。

![未命名1592898617](D:\git\读书笔记\NIO\未命名1592898617.png)

概念上，缓冲区是包在一个对象内的基本数据元素数组。Buffer 类相比一个简单数组的优点，是它将关于数据的数据内容和信息包含在一个单一的对象中。Buffer 类以及它专有的子类定义了一个用于处理数据缓冲区的 API。

## 1.1 属性

所有的缓冲区都具有四个属性来提供关于其所包含的数据元素的信息

### 容量(capacity)

缓冲区能够容纳的数据元素的最大数量。这一容量在缓冲区创建时被设定，并且永远不能被改变。 

### 上界(limit)

缓冲区的第一个不能被读或写的元素。或者说，缓冲区中现存元素的计数

### 位置(position)

下一个要被读或写的元素的索引。位置会自动由相应的 get( )和 put( )函数更新。

### 标记（mark）

一个备忘位置。调用 mark( )来设定 mark = postion。调用 reset( )设定 position = mark。标记在设定前是未定义的(undefined)。

> 几个关系	**0 <= mark <= position <= limit <= capacity** !

一个示例如下：

![未命名1592899194](D:\git\读书笔记\NIO\未命名1592899194.png)

## 1.2 API

我们来看一下Buffer基类的方法

![未命名1592899512](D:\git\读书笔记\NIO\未命名1592899512.png)

> 设计技巧，可以看到很多方法返回对象本身，这种设计方式，能够支持级联调用，也就是所谓的链式调用

## 1.3填充示例

我们把hello填充到一个字节缓冲区中，发生了什么呢

```
buffer.put((byte)'H').put((byte)'e').put((byte)'l').put((byte)'l').put((byte)'o'); 
```

![image-20200623161443738](D:\git\读书笔记\NIO\image-20200623161443738.png)

我们更改缓冲区内容hello->mellow

```
buffer.put(0,(byte)'M').put((byte)'w'); 
```

![image-20200623161826195](D:\git\读书笔记\NIO\image-20200623161826195.png)